<div class="header">
  <app-header></app-header>
</div>

<!-- Loading Indicator -->
<app-loading-modules *ngIf="isLoadingModules"></app-loading-modules>


<div class="main-container d-flex flex-column flex-lg-row">

  <!-- Side Nav -->
  <div class="side-nav p-3 p-lg-4">
    <app-side-nav></app-side-nav>
  </div>

  <!-- Main Content Area -->
  <div class="main-content flex-grow-1 d-flex flex-column">

    <!-- Toolbar -->
    <div class="toolbar my-toolbar p-3 mb-4 d-flex justify-content-between align-items-center flex-wrap">

      <!-- Title -->
      <div class="toolbar-title d-flex align-items-center">
        <fa-icon class="me-3 text-primary fs-2" [icon]="faDriversLicense"></fa-icon>
        <h1 class="h3 mb-0">Licenses</h1>
      </div>

      <!-- Actions (Import, Add, Download) -->
      <div class="toolbar-actions d-flex flex-wrap gap-2">

        <!-- Hidden File Input for Import -->
        <input type="file" (change)="onFileChange($event)" class="d-none" #fileInput accept=".xlsx, .xls">

        <!-- Import Button -->
        <button type="button" class="btn btn-info btn-lg" (click)="fileInput.click()" [disabled]="isLoading">
          <fa-icon [icon]="faUpload"></fa-icon> Import
        </button>

        <!-- Add New Button -->
        <button type="button" class="btn btn-primary btn-lg" (click)="openAddEditAssetsForm()">
          <fa-icon [icon]="faPlus"></fa-icon> Add New
        </button>

        <!-- Download Button -->
        <button type="button" class="btn btn-success btn-lg" (click)="exportToExcel()" [disabled]="isLoading">
          <fa-icon [icon]="faDownload"></fa-icon> Download
        </button>
      </div>
    </div>

    <!-- Filter & Search Section -->
    <div class="mb-4">
      <div class="d-flex align-items-end justify-content-between flex-wrap gap-3">

        <!-- Search Input -->
        <div class="flex-grow-1">
          <div class="d-flex align-items-center mb-2">
            <fa-icon class="me-2 text-muted" [icon]="faMagnifyingGlass"></fa-icon>
            <label for="filterInput" class="form-label fs-5 fw-bold mb-0">Search Licenses</label>
          </div>
          <input type="text" class="form-control form-control-lg" id="filterInput"
                 (keyup)="applyFilter($event)"
                 placeholder="Search by Product Name, Key, Serial Number, etc.">
        </div>

        <!-- License Type Dropdown (Filter) -->
        <div style="min-width: 200px;">
          <label for="categorySelect" class="form-label fs-6 fw-bold mb-1 text-muted">Filter by Type</label>
          <select class="form-select form-select-lg" id="categorySelect" (change)="applyCategoryFilter($event)">
            <option value="All">All Types</option>
            <option value="Subscription">Subscription</option>
            <option value="Perpetual">Perpetual</option>
            <option value="Maintenance">Maintenance</option>
            <option value="SaaS">SaaS</option>
            <option value="OEM">OEM</option>
          </select>
        </div>

      </div>
    </div>

    <!-- Table Section -->
    <div class="table-responsive flex-grow-1">
      <table class="table table-hover table-striped mb-0">
        <thead class="table-primary">
          <tr>
            <!-- Sortable Headers mapped to new DB columns -->
            <th scope="col" (click)="sortData('product_name')">Product Name <fa-icon [icon]="getSortIcon('product_name')"></fa-icon></th>
            <th scope="col" (click)="sortData('license_key')">License Key <fa-icon [icon]="getSortIcon('license_key')"></fa-icon></th>
            <th scope="col" (click)="sortData('serial_number')">Serial Number <fa-icon [icon]="getSortIcon('serial_number')"></fa-icon></th>
            <th scope="col" (click)="sortData('cost_center')">Cost Center <fa-icon [icon]="getSortIcon('cost_center')"></fa-icon></th>
            <th scope="col" (click)="sortData('vendor')">Vendor <fa-icon [icon]="getSortIcon('vendor')"></fa-icon></th>
            <th scope="col" (click)="sortData('license_type')">Type <fa-icon [icon]="getSortIcon('license_type')"></fa-icon></th>
            <th scope="col" (click)="sortData('contract_date')">Contract Date <fa-icon [icon]="getSortIcon('contract_date')"></fa-icon></th>
            <th scope="col" class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data Row -->
          <tr *ngFor="let row of displayedData; let i = index" (click)="openAssetDetailsModal(row)" class="table-row-hover">
            <!-- Data Cells mapped to new DB columns -->
            <td>{{ row.product_name }}</td>
            <td>{{ row.license_key }}</td>
            <td>{{ row.serial_number }}</td>
            <td>{{ row.cost_center }}</td>
            <td>{{ row.vendor }}</td>
            <td>
              <!-- Optional: Badge styling for License Type -->
              <span class="badge rounded-pill bg-secondary text-light fw-normal"
                    [ngClass]="{'bg-success': row.license_type === 'Perpetual', 'bg-info': row.license_type === 'Subscription'}">
                {{ row.license_type }}
              </span>
            </td>
            <td>{{ row.contract_date | date:'shortDate' }}</td>

            <!-- Action Buttons -->
            <td class="action-buttons-cell text-center">
              <button type="button" class="btn btn-outline-primary btn-sm me-1" (click)="openAddEditAssetsForm(row); $event.stopPropagation()" title="Edit">
                <fa-icon [icon]="faEdit"></fa-icon>
              </button>
              <button type="button" class="btn btn-outline-danger btn-sm" (click)="deleteAsset(row.id); $event.stopPropagation()" title="Delete">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="displayedData.length === 0 && !isLoadingModules && !isLoading">
            <td colspan="8" class="text-center py-4 text-muted">
              <fa-icon [icon]="faMagnifyingGlass" class="mb-2 fs-4 d-block"></fa-icon>
              No Licenses found matching your search.
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination Controls Section -->
    <div class="d-flex align-items-center justify-content-between mt-3 pagination-controls-wrapper flex-wrap gap-3">

      <!-- Items per page selector -->
      <div class="items-per-page-controls d-flex align-items-center gap-2">
        <label for="pageSizeSelect" class="form-label mb-0">Items per page:</label>
        <select class="form-select" [(ngModel)]="pageSize" (change)="onPageSizeChange()" id="pageSizeSelect" style="width: auto;">
          <option [ngValue]="5">5</option>
          <option [ngValue]="10">10</option>
          <option [ngValue]="25">25</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
          <option [ngValue]="'all'">All</option>
        </select>
      </div>

      <!-- Pagination Navigation -->
      <nav aria-label="Page navigation" *ngIf="totalPages > 1 && pageSize !== 'all'">
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="page === 1">
            <a class="page-link" (click)="onPageChange(page - 1)" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>

          <li class="page-item" *ngFor="let p of getPages()" [class.active]="p === page" [class.disabled]="p === '...'">
            <a class="page-link" (click)="handlePageLinkClick(p)">
              {{ p }}
            </a>
          </li>

          <li class="page-item" [class.disabled]="page === totalPages">
            <a class="page-link" (click)="onPageChange(page + 1)" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
        </ul>
      </nav>

      <!-- Results Info -->
      <div class="results-info" *ngIf="pageSize !== 'all'">
        Showing {{ (page - 1) * (pageSize || 1) + 1 }} - {{ (page - 1) * (pageSize || 1) + displayedData.length }} of {{ dataSource.length }} results
      </div>
      <div class="results-info" *ngIf="pageSize === 'all'">
        Showing {{ dataSource.length }} results
      </div>

    </div>

    <!-- Footer -->
    <div class="footer mt-4 p-3 text-center">
      <p class="mb-0 text-muted">(C)2025 - Developed by Manila Infrastructure Team</p>
    </div>

  </div>
</div>
